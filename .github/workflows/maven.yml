name: PolyCafe CI/CD Automation

on:
  pull_request:
    branches: [ "main", "master" ]
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    # --- PHẦN MỚI THÊM: Tạo máy chủ SQL Server ảo ---
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          # LƯU Ý: Mật khẩu SQL Server bắt buộc phải có: Chữ Hoa, thường, số và ký tự đặc biệt
          SA_PASSWORD: "Password123!" 
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433
        # Đợi DB khởi động xong mới chạy các bước tiếp theo
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'Password123!' -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    # ------------------------------------------------

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # --- QUAN TRỌNG: Cấu hình lại file kết nối Database trong Java ---
    # Vì DB ảo này có password là "Password123!", bạn cần đảm bảo code Java kết nối đúng pass này.
    # Nếu code Java của bạn đang để cứng password khác, bạn có thể dùng lệnh này để ghi đè file cấu hình 
    # (Ví dụ: ghi đè file context.xml hoặc application.properties nếu cần)
    # Nhưng đơn giản nhất là sửa code Java hoặc dùng biến môi trường.
    
    - name: Build with Maven
      # Truyền biến môi trường DB_PASSWORD vào nếu code bạn hỗ trợ đọc biến môi trường
      env: 
        DB_PASSWORD: "Password123!"
      run: mvn -B package --file pom.xml
      
    - name: Notify Success
      if: success()
      run: echo "Code xịn! Đã kết nối được DB và Build thành công."